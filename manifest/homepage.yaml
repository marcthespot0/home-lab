---
kind: Namespace
apiVersion: v1
metadata:
  name: homepage
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: homepage
  namespace: homepage
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  project: homepage
  syncPolicy:
    automated:
      selfHeal: true
      prune: true
    syncOptions:
      - CreateNamespace=true
  destination:
    name: in-cluster
    namespace: apps
  source:
    repoURL: https://bjw-s.github.io/helm-charts 
    chart: app-template
    targetRevision: 2.6.0
    helm:
      valuesObject: 
        serviceAccount:
          create: true
          name: "homepage"
        controllers:
          main:
            replicas: 1
            containers:
              main:
                image:
                  repository: ghcr.io/gethomepage/homepage
                  tag: v0.8.4
        service:
          main:
            ports:
              http:
                port: 3000
                protocol: HTTP
        persistence:
          config:
            enabled: true
            type: configMap
            name: homepage-config
            globalMounts:
              - path: /app/config/settings.yaml
                subPath: settings.yaml
              - path: /app/config/widgets.yaml
                subPath: widgets.yaml
              - path: /app/config/services.yaml
                subPath: services.yaml
              - path: /app/config/bookmarks.yaml
                subPath: bookmarks.yaml
              - path: /app/config/kubernetes.yaml
                subPath: kubernetes.yaml
        configMaps:
          config:
            enabled: true
            data:
              kubernetes.yaml: |
                mode: cluster 
              settings.yaml: |
                title: Index
                background: https://imagedelivery.net/34xh1sPWPAwO1lv63pW2Eg/992fd3c9-33f9-461e-6894-7210ef7a1500/public
                cardBlur: md
                theme: dark
                headerStyle: boxed
                hideVersion: true
              widgets.yaml: |
                - search:
                    provider: google
                    target: _blank
                - kubernetes:
                    cluster:
                      show: false
                    nodes:
                      show: true
                      cpu: true
                      memory: true
                      showLabel: true
              services.yaml: |
                - Entertainment: 
                  - Matrix:
                      href: https://chat.{{ .Values.global.domain }}
                      description: Chat client
                      icon: element.svg
                  - Jellyfin:
                      href: https://jellyfin.{{ .Values.global.domain }}
                      description: Media system (movies, music, etc.)
                      icon: jellyfin.svg
                  - Jellyseerr:
                      href: https://jellyseerr.{{ .Values.global.domain }}
                      description: Request media
                      icon: jellyseerr.svg
                - Management:
                  - Transmission:
                      href: https://transmission.{{ .Values.global.domain }}
                      description: Bittorrent client
                      icon: transmission.svg
                  - Prowlarr:
                      href: https://prowlarr.{{ .Values.global.domain }}
                      description: Indexer manager
                      icon: prowlarr.svg
                  - Radarr:
                      href: https://radarr.{{ .Values.global.domain }}
                      description: Movie manager
                      icon: radarr.svg
                  - Sonarr:
                      href: https://sonarr.{{ .Values.global.domain }}
                      description: TV show manager
                      icon: sonarr.svg
                  - Kanidm:
                      href: https://auth.{{ .Values.global.domain }}
                      description: Identity management
                      icon: https://auth.{{ .Values.global.domain }}/pkg/img/logo-square.svg
                - Development:
                  - ArgoCD:
                      href: https://argocd.{{ .Values.global.domain }}
                      description: Continuous deployment
                      icon: argocd.svg
                  - Grafana:
                      href: https://grafana.{{ .Values.global.domain }}
                      description: Observability dashboards
                      icon: grafana.svg
                  - Longhorn:
                      href: https://longhorn.{{ .Values.global.domain }}
                      description: Distributed block storage
                      icon: longhorn.svg
                - Utilities:
                  - Excalidraw:
                      href: https://draw.{{ .Values.global.domain }}
                      description: Virtual whiteboard
                      icon: excalidraw.svg
                  - Speedtest:
                      href: https://speedtest.{{ .Values.global.domain }}
                      description: Internal network speed test
                      icon: openspeedtest.png
              bookmarks.yaml: |
                - Homelab:
                  - Documentation:
                    - href: https://humble.{{ .Values.global.domain }}
                      icon: google-docs.svg
                  - Public repository:
                    - href: https://github.com/locmai/humble
                      icon: github.svg
                - Managed services:
                  - Cloudflare:
                    - href: https://dash.cloudflare.com
                      icon: cloudflare.svg
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: homepage
  namespace: homepage
  labels:
    app.kubernetes.io/name: homepage
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: 20M
    gethomepage.dev/description: Dynamically Detected Homepage
    gethomepage.dev/enabled: "true"
    gethomepage.dev/group: Cluster Management
    gethomepage.dev/icon: homepage.png
    gethomepage.dev/name: Homepage
spec:
  ingressClassName: ingress-nginx-internal
  rules:
    - host: "home.<path:stringreplacesecret#domain>"
      http:
        paths:
          - path: "/"
            pathType: Prefix
            backend:
              service:
                name: homepage
                port:
                  number: 3000
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: homepage
  namespace: homepage
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  parentRefs:
  - name: internal
    namespace: gateway
    sectionName: https
  hostnames:
  - "home.<path:stringreplacesecret#domain>"
  rules:
  - backendRefs:
    - name: homepage
      port: 80
---
apiVersion: externaldns.k8s.io/v1alpha1
kind: DNSEndpoint
metadata:
  name: homepage
  namespace: homepage
  annotations:
    external-dns.custom/type: private
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  endpoints:
    - dnsName: home.<path:stringreplacesecret#domain>
      recordType: CNAME
      targets:
        - intgw.<path:stringreplacesecret#domain>
      providerSpecific:
        - name: external-dns.alpha.kubernetes.io/cloudflare-proxied
          value: "false"