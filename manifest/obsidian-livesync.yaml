kind: Namespace
apiVersion: v1
metadata:
  name: obsidian-livesync

---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: obsidian-livesync
  namespace: argocd
spec:
  destination:
    namespace: obsidian-livesync
    server: https://kubernetes.default.svc
  project: homelab
  source:
    chart: app-template 
    repoURL: http://bjw-s.github.io/helm-charts/
    targetRevision: 3.3.1
    helm:
      values: |
        defaultPodOptions:
          securityContext:
            runAsUser: 568
            runAsGroup: 568
            fsGroup: 568
            fsGroupChangePolicy: OnRootMismatch

        service:
          app:
            controller: obsidian-couchdb
            ports:
              http:
                port: 5984
        
        persistence:
          config:
            enabled: true
            type: configMap
            name: obsidian-couchdb-configmap
            
          data:
            enabled: true
            existingClaim: obsidian-couchdb-data
            
          config-storage:
            enabled: true
            type: emptyDir

  ignoreManifestDifferences:
    - key: spec.template.spec.containers[0].image
      value: public.ecr.aws/docker/library/busybox:latest@sha256:9ae97d36d26566ff84e8893c64a6dc4fe8ca6d1144bf5b87b2b85a32def253c7
        
  syncPolicy:
    automated:
      - selfHeal: true
        prune: false

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: obsidian-couchdb-configmap
  namespace: obsidian-livesync
data:
  couchdb.ini: |
    single_node = true
    max_document_size = 50000000

    [chttpd]
    require_valid_user = true
    bind_address = any
    max_http_request_size = 4294967296

    [httpd_auth]
    require_valid_user = true
    authentication_redirect = /_utils/session.html

    [httpd]
    WWW-Authenticate = Basic realm="couchdb"
    enable_cors = true

    [cors]
    origins = app://obsidian.md,capacitor://localhost,http://localhost
    credentials = true
    headers = accept, authorization, content-type, origin, referer
    methods = GET, PUT, POST, HEAD, DELETE
    max_age = 3600