apiVersion: v1
kind: Namespace
metadata:
  name: guacamole
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: guacamole-configsecrets
  namespace: guacamole
  labels:
    app.kubernetes.io/part-of: guacamole
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  refreshInterval: "5m"
  secretStoreRef:
    kind: ClusterSecretStore
    name: 1password
  target:
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        POSTGRESQL_USER: "{{ .user }}"
        POSTGRESQL_PASSWORD: "{{ .pass }}"
        POSTGRESQL_HOSTNAME: "{{ .hostname }}"
        POSTGRESQL_DATABASE: "{{ .database }}"
  data:
    - secretKey: user
      remoteRef:
        key: guacamole-configsecrets
        property: POSTGRESQL_USER
    - secretKey: pass
      remoteRef:
        key: guacamole-configsecrets
        property: POSTGRESQL_PASSWORD
    - secretKey: hostname
      remoteRef:
        key: guacamole-configsecrets
        property: POSTGRESQL_HOSTNAME
    - secretKey: database
      remoteRef:
        key: guacamole-configsecrets
        property: POSTGRESQL_DATABASE
---
apiVersion: v1
kind: Service
metadata:
  name: guacd
  namespace: guacamole
spec:
  selector:
    app: guacd
  ports:
    - protocol: TCP
      port: 4822
      targetPort: 4822
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: guacamole
spec:
  selector:
    app: postgres
  ports:
    - protocol: TCP
      port: 5432
      targetPort: 5432
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: guacamole
  namespace: guacamole
spec:
  selector:
    app: guacamole
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: guacamole
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
spec:
  project: default
  source:
    chart: app-template
    repoURL: https://bjw-s-labs.github.io/helm-charts
    targetRevision: 4.3.0
    helm:
      values: |
        controllers:
          guacamole:
            annotations:
              reloader.stakater.com/auto: "true"
            initContainers:
              01-init-schema:
                image:
                  repository: docker.io/guacamole/guacamole
                  tag: 1.6.0
                envFrom: &envFrom
                  - secretRef:
                      name: guacamole-configsecrets
                command:
                  - "/bin/sh"
                  - "-c"
                args:
                  - /opt/guacamole/bin/initdb.sh --postgresql > /migrations/initdb.sql
              02-init-db:
                image:
                  repository: ghcr.io/home-operations/postgres-init
                  tag: 17.6.0
                  pullPolicy: IfNotPresent
                envFrom: *envFrom
                command:
                  - "/bin/bash"
                  - "-c"
                args:
                  # - export PGPASSWORD=$(POSTGRESQL_PASSWORD);
                    psql -h $(POSTGRESQL_HOSTNAME) -d $(POSTGRESQL_DATABASE) -U $(POSTGRESQL_USER) -a -w -f /migrations/initdb.sql || true;
              03-init-plugin:
                image:
                  repository: docker.io/guacamole/guacamole
                  tag: 1.6.0
                command:
                  - "/bin/sh"
                  - "-c"
                args:
                  - mkdir -p /guacamole/extensions;
                    cp /opt/guacamole/totp/*.jar /guacamole/extensions;
            containers:
              app:
                image:
                  repository: docker.io/flcontainers/guacamole
                  tag: 1.6.0
                env:
                  TZ: ${TIMEZONE}
                  WEBAPP_CONTEXT: ROOT
                  GUACAMOLE_HOME: /guacamole
                envFrom: *envFrom
                resources:
                  requests:
                    cpu: 250m
                    memory: 128Mi
                  limits:
                    memory: 750Mi
        persistence:
          migrations:
            type: emptyDir
            advancedMounts:
              guacamole:
                01-init-schema:
                  - path: /migrations
                02-init-db:
                  - path: /migrations    
  destination:
    server: https://kubernetes.default.svc
    namespace: guacamole
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    app: postgres
  name: guac-init
  namespace: guacamole
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    app: postgres
  name: guac-data
  namespace: guacamole
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    app: guacd
  name: guac-drive
  namespace: guacamole
spec:
  accessModes: ["ReadWriteMany"]
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    app: guacamole
  name: guac-record
  namespace: guacamole
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 5Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    app: guacamole
  name: guac-config
  namespace: guacamole
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 1Gi
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: guacamole-ingress
  namespace: guacamole
  annotations:
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
spec:
  ingressClassName: ingress-nginx-internal
  rules:
  - host: guac.<path:stringreplacesecret#domain>
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: guacamole
            port:
              number: 8080
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: guacamole-http
  namespace: guacamole
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  parentRefs:
    - name: internal
      namespace: gateway
      sectionName: https
    - name: external
      namespace: gateway
      sectionName: https
  hostnames:
  - "guac.<path:stringreplacesecret#domain>"
  rules:
    - backendRefs:
      - name: guacamole
        port: 80
---
apiVersion: externaldns.k8s.io/v1alpha1
kind: DNSEndpoint
metadata:
  name: guacamole-external
  namespace: guacamole
  annotations:
    external-dns.custom/type: public
spec:
  endpoints:
    - dnsName: guac.<path:stringreplacesecret#domain>
      recordType: CNAME
      targets:
        - ingress.<path:stringreplacesecret#domain>
      providerSpecific:
        - name: external-dns.alpha.kubernetes.io/cloudflare-proxied
          value: "true"
---
apiVersion: externaldns.k8s.io/v1alpha1
kind: DNSEndpoint
metadata:
  name: guacamole
  namespace: guacamole
  annotations:
    external-dns.custom/type: private
spec:
  endpoints:
    - dnsName: guac.<path:stringreplacesecret#domain>
      recordType: CNAME
      targets:
        - intgw.<path:stringreplacesecret#domain>
      providerSpecific: